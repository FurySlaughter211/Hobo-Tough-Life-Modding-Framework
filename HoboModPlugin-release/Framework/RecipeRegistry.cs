using System;
using System.Collections.Generic;
using System.IO;
using BepInEx.Logging;
using UnityEngine;
using Game;

namespace HoboModPlugin.Framework
{
    /// <summary>
    /// Registry for custom recipes - handles loading from JSON and injection into game
    /// </summary>
    public class RecipeRegistry
    {
        private readonly ManualLogSource _log;
        private readonly ItemRegistry _itemRegistry;
        private readonly Dictionary<string, RegisteredRecipe> _recipes = new();
        
        private uint _nextRecipeId = 51000;
        
        public RecipeRegistry(ManualLogSource log, ItemRegistry itemRegistry)
        {
            _log = log;
            _itemRegistry = itemRegistry;
        }
        
        /// <summary>
        /// Load all recipes from a mod's recipes folder
        /// </summary>
        public void LoadRecipesFromMod(ModManifest mod)
        {
            var recipesPath = Path.Combine(mod.FolderPath, "recipes");
            if (!Directory.Exists(recipesPath)) return;
            
            var recipeFiles = Directory.GetFiles(recipesPath, "*.json");
            _log.LogInfo($"  Loading {recipeFiles.Length} recipe(s) from {mod.Name}");
            
            foreach (var recipeFile in recipeFiles)
            {
                try
                {
                    var json = File.ReadAllText(recipeFile);
                    var definition = Newtonsoft.Json.JsonConvert.DeserializeObject<RecipeDefinition>(json);
                    
                    if (definition == null) continue;
                    
                    RegisterRecipe(mod, definition);
                }
                catch (Exception ex)
                {
                    _log.LogError($"    Failed to load {Path.GetFileName(recipeFile)}: {ex.Message}");
                }
            }
        }
        
        private void RegisterRecipe(ModManifest mod, RecipeDefinition definition)
        {
            var numericId = _nextRecipeId++;
            var fullId = $"{mod.Id}:{definition.Id}";
            
            var registered = new RegisteredRecipe
            {
                FullId = fullId,
                NumericId = numericId,
                Mod = mod,
                Definition = definition
            };
            
            _recipes[fullId] = registered;
            
            _log.LogInfo($"    Registered recipe: {definition.Id} -> ID {numericId}");
        }
        
        /// <summary>
        /// Inject all registered recipes into the game's RecipeDatabase
        /// </summary>
        public void InjectAllRecipes()
        {
            var recipes = RecipeDatabase.recipes;
            if (recipes == null || recipes.Count == 0)
            {
                _log.LogWarning("RecipeDatabase not ready");
                return;
            }
            
            _log.LogInfo($"=== RecipeRegistry: Injecting {_recipes.Count} recipes ===");
            
            foreach (var entry in _recipes)
            {
                InjectRecipe(entry.Value);
            }
        }
        
        private void InjectRecipe(RegisteredRecipe registered)
        {
            try
            {
                var definition = registered.Definition;
                var recipes = RecipeDatabase.recipes;
                
                // Skip if already injected
                if (recipes.ContainsKey(registered.NumericId)) return;
                
                // Find an Item-type recipe to clone
                Recipe sourceRecipe = null;
                foreach (var r in recipes.Values)
                {
                    if (r != null && r.type == Recipe.RecipeType.Item)
                    {
                        sourceRecipe = r;
                        break;
                    }
                }
                
                if (sourceRecipe == null)
                {
                    _log.LogWarning($"    No source recipe found for {definition.Id}");
                    return;
                }
                
                // Clone the recipe
                var clonedObj = sourceRecipe.Clone();
                var customRecipe = clonedObj?.TryCast<Recipe>();
                if (customRecipe == null) return;
                
                // Configure basic properties
                customRecipe.id = registered.NumericId;
                customRecipe.type = Recipe.RecipeType.Item;
                customRecipe.index = 40 + (int)(registered.NumericId - 51000);
                customRecipe.requireSkillLvl = definition.SkillRequired;
                customRecipe.notActive = false;
                customRecipe.craftingDifficulty = 0;
                customRecipe.requireSK = StreetKnowledgeManager.Keys.NOTHING;
                
                // Set recipe name
                var recipeName = ResolveLocalizedString(registered, definition.Name);
                customRecipe.Title = recipeName;
                customRecipe.title = recipeName;
                
                // Resolve result item
                var resultItem = ResolveResultItem(registered);
                if (resultItem == null)
                {
                    _log.LogWarning($"    Result item not found for recipe {definition.Id}");
                    return;
                }
                
                customRecipe.resultItemId = resultItem.NumericId;
                customRecipe._resultItem = resultItem.GameItem;
                
                // Parse bench type
                customRecipe.myBench = ParseBenchType(definition.Bench);
                
                // Set ingredients
                var reqList = new Il2CppSystem.Collections.Generic.List<RecipeRequireItem>();
                foreach (var ing in definition.Ingredients)
                {
                    var req = new RecipeRequireItem();
                    req.itemID = ing.Item;
                    req.itemCount = ing.Count;
                    reqList.Add(req);
                }
                customRecipe.RequireItemsPrimary = reqList;
                customRecipe.RequireItemsSecondary = new Il2CppSystem.Collections.Generic.List<RecipeRequireItem>();
                
                // Add to database
                recipes[registered.NumericId] = customRecipe;
                registered.GameRecipe = customRecipe;
                
                _log.LogInfo($"    Injected recipe: {definition.Id} (ID: {registered.NumericId})");
                
                // Auto-unlock if specified
                if (definition.AutoUnlock)
                {
                    registered.PendingUnlock = true;
                }
            }
            catch (Exception ex)
            {
                _log.LogError($"    Failed to inject recipe {registered.Definition.Id}: {ex.Message}");
            }
        }
        
        private RegisteredItem ResolveResultItem(RegisteredRecipe registered)
        {
            var resultId = registered.Definition.Result;
            
            // Try full mod ID first (mod_id:item_id)
            var fullId = $"{registered.Mod.Id}:{resultId}";
            var item = _itemRegistry.GetItem(fullId);
            if (item != null) return item;
            
            // Try just the item ID
            item = _itemRegistry.GetItem(resultId);
            if (item != null) return item;
            
            // Search all items for matching ID suffix
            // This allows recipes to reference items by short name
            return null; // Item not found
        }
        
        private Recipe.BenchType ParseBenchType(string bench)
        {
            if (string.IsNullOrEmpty(bench)) return Recipe.BenchType.Nothing;
            
            return bench.ToLowerInvariant() switch
            {
                "none" => Recipe.BenchType.Nothing,
                "nothing" => Recipe.BenchType.Nothing,
                "normal" => Recipe.BenchType.Normal,
                "kitchen" => Recipe.BenchType.Kitchen,
                "druglab" => Recipe.BenchType.DrugLab,
                "drug" => Recipe.BenchType.DrugLab,
                _ => Recipe.BenchType.Nothing
            };
        }
        
        private string ResolveLocalizedString(RegisteredRecipe registered, string key)
        {
            if (string.IsNullOrEmpty(key)) return "Unknown Recipe";
            
            if (key.StartsWith("@"))
            {
                var locKey = key.Substring(1);
                var locPath = Path.Combine(registered.Mod.FolderPath, "localization", "en.json");
                
                if (File.Exists(locPath))
                {
                    try
                    {
                        var json = File.ReadAllText(locPath);
                        var loc = Newtonsoft.Json.JsonConvert.DeserializeObject<Dictionary<string, string>>(json);
                        if (loc != null && loc.TryGetValue(locKey, out var value))
                        {
                            return value;
                        }
                    }
                    catch { }
                }
                
                return locKey;
            }
            
            return key;
        }
        
        /// <summary>
        /// Unlock auto-unlock recipes for the player
        /// Should be called on every save load, not just first time
        /// </summary>
        public void UnlockPendingRecipes(Character player)
        {
            foreach (var entry in _recipes)
            {
                var registered = entry.Value;
                // Use Definition.AutoUnlock (persists) instead of PendingUnlock flag (gets cleared)
                if (registered.Definition.AutoUnlock && registered.GameRecipe != null)
                {
                    if (!player.HasRecipe(registered.NumericId))
                    {
                        try
                        {
                            player.AddRecipe(registered.GameRecipe, false, false);
                            _log.LogInfo($"  Auto-unlocked recipe: {registered.Definition.Id}");
                        }
                        catch { }
                    }
                }
            }
        }
        
        public int Count => _recipes.Count;
    }
    
    /// <summary>
    /// Runtime registered recipe data
    /// </summary>
    public class RegisteredRecipe
    {
        public string FullId { get; set; } = "";
        public uint NumericId { get; set; }
        public ModManifest Mod { get; set; }
        public RecipeDefinition Definition { get; set; }
        public Recipe GameRecipe { get; set; }
        public bool PendingUnlock { get; set; }
    }
}
